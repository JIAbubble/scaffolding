# æ ¸å¿ƒåŠŸèƒ½ä½¿ç”¨è¯´æ˜

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯´æ˜æ–°å¢çš„5ä¸ªæ ¸å¿ƒåŠŸèƒ½çš„ä½¿ç”¨æ–¹æ³•ã€‚

---

## 1. å…¨å±€å¼‚å¸¸å¤„ç†å™¨

### åŠŸèƒ½è¯´æ˜

`GlobalExceptionHandler` ç»Ÿä¸€å¤„ç†æ‰€æœ‰å¼‚å¸¸ï¼Œè¿”å›ç»Ÿä¸€çš„é”™è¯¯å“åº”æ ¼å¼ã€‚

### è‡ªåŠ¨å¤„ç†çš„å¼‚å¸¸ç±»å‹

- âœ… `BusinessException` - ä¸šåŠ¡å¼‚å¸¸
- âœ… `ParameterException` - å‚æ•°å¼‚å¸¸
- âœ… `MethodArgumentNotValidException` - å‚æ•°æ ¡éªŒå¼‚å¸¸ï¼ˆ@Validatedï¼‰
- âœ… `BindException` - å‚æ•°ç»‘å®šå¼‚å¸¸
- âœ… `ConstraintViolationException` - çº¦æŸè¿åå¼‚å¸¸ï¼ˆ@Validï¼‰
- âœ… `MethodArgumentTypeMismatchException` - å‚æ•°ç±»å‹ä¸åŒ¹é…
- âœ… `NullPointerException` - ç©ºæŒ‡é’ˆå¼‚å¸¸
- âœ… `IllegalArgumentException` - éæ³•å‚æ•°å¼‚å¸¸
- âœ… `Exception` - å…¶ä»–æœªæ•è·çš„å¼‚å¸¸

### ä½¿ç”¨ç¤ºä¾‹

```java
@Service
public class UserService {
    
    public User getUserById(Long id) {
        User user = this.getById(id);
        if (user == null) {
            // æŠ›å‡ºä¸šåŠ¡å¼‚å¸¸ï¼Œå…¨å±€å¼‚å¸¸å¤„ç†å™¨ä¼šè‡ªåŠ¨å¤„ç†
            throw new BusinessException(ResultCode.DATA_NOT_EXIST);
        }
        return user;
    }
    
    public void createUser(UserCreateForm form) {
        // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
        User existing = this.getOne(
            new LambdaQueryWrapper<User>()
                .eq(User::getUsername, form.getUsername())
        );
        if (existing != null) {
            throw new BusinessException("ç”¨æˆ·åå·²å­˜åœ¨");
        }
        
        // åˆ›å»ºç”¨æˆ·...
    }
}
```

### å“åº”æ ¼å¼

```json
{
  "code": 1003,
  "status": false,
  "message": "æ•°æ®ä¸å­˜åœ¨",
  "data": null
}
```

---

## 2. ç»Ÿä¸€å“åº”åŒ…è£…å™¨

### åŠŸèƒ½è¯´æ˜

`GlobalResponseBodyAdvice` è‡ªåŠ¨å°†æ‰€æœ‰Controllerè¿”å›å€¼åŒ…è£…ä¸º `ResponseResult` æ ¼å¼ã€‚

### ä½¿ç”¨ç¤ºä¾‹

```java
@RestController
@RequestMapping("/api/users")
public class UserController {
    
    @GetMapping("/{id}")
    // ç›´æ¥è¿”å›Userå¯¹è±¡ï¼Œä¼šè‡ªåŠ¨åŒ…è£…ä¸ºResponseResult<User>
    public User getUser(@PathVariable Long id) {
        return userService.getById(id);
    }
    
    @GetMapping
    // è¿”å›Listï¼Œä¼šè‡ªåŠ¨åŒ…è£…ä¸ºResponseResult<List<User>>
    public List<User> listUsers() {
        return userService.list();
    }
    
    // å¦‚æœå·²ç»è¿”å›ResponseResultï¼Œåˆ™ä¸ä¼šé‡å¤åŒ…è£…
    @PostMapping
    public ResponseResult<User> createUser(@RequestBody UserCreateForm form) {
        User user = userService.create(form);
        return ResponseResult.success(user);
    }
}
```

### å“åº”æ ¼å¼

**è‡ªåŠ¨åŒ…è£…å‰**ï¼š
```json
{
  "id": 1,
  "username": "testuser",
  "email": "test@example.com"
}
```

**è‡ªåŠ¨åŒ…è£…å**ï¼š
```json
{
  "code": 200,
  "status": true,
  "message": "æ“ä½œæˆåŠŸ",
  "data": {
    "id": 1,
    "username": "testuser",
    "email": "test@example.com"
  }
}
```

### æ’é™¤è§„åˆ™

ä»¥ä¸‹è·¯å¾„çš„å“åº”ä¸ä¼šè¢«åŒ…è£…ï¼š
- `/swagger-ui/**`
- `/v3/api-docs/**`
- `/error`
- `/favicon.ico`

---

## 3. è‡ªå®šä¹‰å¼‚å¸¸ç±»

### BusinessException - ä¸šåŠ¡å¼‚å¸¸

```java
// æ–¹å¼1ï¼šä½¿ç”¨é»˜è®¤é”™è¯¯ç 
throw new BusinessException("ç”¨æˆ·åå·²å­˜åœ¨");

// æ–¹å¼2ï¼šæŒ‡å®šé”™è¯¯ç 
throw new BusinessException(1001, "ç”¨æˆ·åå·²å­˜åœ¨");

// æ–¹å¼3ï¼šä½¿ç”¨ResultCodeæšä¸¾
throw new BusinessException(ResultCode.DATA_NOT_EXIST);

// æ–¹å¼4ï¼šä½¿ç”¨ResultCode + è‡ªå®šä¹‰æ¶ˆæ¯
throw new BusinessException(ResultCode.DATA_NOT_EXIST, "ç”¨æˆ·ä¸å­˜åœ¨");
```

### ParameterException - å‚æ•°å¼‚å¸¸

```java
// æ–¹å¼1ï¼šå•ä¸ªé”™è¯¯æ¶ˆæ¯
throw new ParameterException("ç”¨æˆ·åä¸èƒ½ä¸ºç©º");

// æ–¹å¼2ï¼šå¤šä¸ªé”™è¯¯æ¶ˆæ¯
List<String> errors = Arrays.asList(
    "ç”¨æˆ·åä¸èƒ½ä¸ºç©º",
    "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®"
);
throw new ParameterException("å‚æ•°æ ¡éªŒå¤±è´¥", errors);

// æ–¹å¼3ï¼šåªä¼ é”™è¯¯åˆ—è¡¨
throw new ParameterException(errors);
```

---

## 4. å¤šç¯å¢ƒé…ç½®

### é…ç½®æ–‡ä»¶è¯´æ˜

- `application.yml` - ä¸»é…ç½®æ–‡ä»¶ï¼ˆå…¬å…±é…ç½®ï¼‰
- `application-dev.yml` - å¼€å‘ç¯å¢ƒé…ç½®
- `application-test.yml` - æµ‹è¯•ç¯å¢ƒé…ç½®
- `application-prod.yml` - ç”Ÿäº§ç¯å¢ƒé…ç½®

### æ¿€æ´»ç¯å¢ƒ

#### æ–¹å¼1ï¼šåœ¨application.ymlä¸­é…ç½®ï¼ˆé»˜è®¤ï¼‰

```yaml
spring:
  profiles:
    active: dev  # é»˜è®¤ä½¿ç”¨å¼€å‘ç¯å¢ƒ
```

#### æ–¹å¼2ï¼šå¯åŠ¨å‚æ•°

```bash
# å¼€å‘ç¯å¢ƒ
java -jar app.jar --spring.profiles.active=dev

# æµ‹è¯•ç¯å¢ƒ
java -jar app.jar --spring.profiles.active=test

# ç”Ÿäº§ç¯å¢ƒ
java -jar app.jar --spring.profiles.active=prod
```

#### æ–¹å¼3ï¼šç¯å¢ƒå˜é‡

```bash
export SPRING_PROFILES_ACTIVE=prod
java -jar app.jar
```

#### æ–¹å¼4ï¼šIDEé…ç½®

**IntelliJ IDEA**ï¼š
1. Run â†’ Edit Configurations
2. åœ¨ VM options æˆ– Program arguments ä¸­æ·»åŠ ï¼š`--spring.profiles.active=dev`

**Eclipse**ï¼š
1. Run â†’ Run Configurations
2. Arguments â†’ Program argumentsï¼š`--spring.profiles.active=dev`

### ç¯å¢ƒé…ç½®å·®å¼‚

| é…ç½®é¡¹ | å¼€å‘ç¯å¢ƒ | æµ‹è¯•ç¯å¢ƒ | ç”Ÿäº§ç¯å¢ƒ |
|--------|---------|---------|---------|
| SQLæ—¥å¿— | æ‰“å°åˆ°æ§åˆ¶å° | ä½¿ç”¨æ—¥å¿— | ä½¿ç”¨æ—¥å¿— |
| æ—¥å¿—çº§åˆ« | DEBUG | INFO | WARN |
| Swagger | å¯ç”¨ | å¯é€‰ | ç¦ç”¨ |
| æ•°æ®åº“è¿æ¥æ±  | è¾ƒå° | ä¸­ç­‰ | è¾ƒå¤§ |

---

## 5. è¯·æ±‚æ—¥å¿—æ‹¦æˆªå™¨

### åŠŸèƒ½è¯´æ˜

`LoggingInterceptor` è‡ªåŠ¨è®°å½•æ‰€æœ‰HTTPè¯·æ±‚å’Œå“åº”ä¿¡æ¯ã€‚

### è®°å½•å†…å®¹

- âœ… è¯·æ±‚æ–¹æ³•ã€URIã€URL
- âœ… å®¢æˆ·ç«¯IPåœ°å€
- âœ… è¯·æ±‚å¤´ä¿¡æ¯
- âœ… è¯·æ±‚å‚æ•°
- âœ… è¯·æ±‚ä½“ï¼ˆPOST/PUTè¯·æ±‚ï¼‰
- âœ… å“åº”çŠ¶æ€ç 
- âœ… å“åº”å¤´ä¿¡æ¯
- âœ… å“åº”ä½“ï¼ˆé™åˆ¶1000å­—ç¬¦ï¼‰
- âœ… è¯·æ±‚è€—æ—¶ï¼ˆæ¯«ç§’ï¼‰
- âœ… å¼‚å¸¸ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰

### æ—¥å¿—çº§åˆ«

- **DEBUGçº§åˆ«**ï¼šè®°å½•å®Œæ•´çš„è¯·æ±‚å’Œå“åº”ä¿¡æ¯
- **INFOçº§åˆ«**ï¼šåªè®°å½•å…³é”®ä¿¡æ¯ï¼ˆæ–¹æ³•ã€URIã€çŠ¶æ€ç ã€è€—æ—¶ï¼‰

### é…ç½®æ—¥å¿—çº§åˆ«

åœ¨ `application.yml` ä¸­ï¼š

```yaml
logging:
  level:
    com.example.performanceevaluation.interceptor: debug  # å®Œæ•´æ—¥å¿—
    # æˆ–
    com.example.performanceevaluation.interceptor: info   # ç®€åŒ–æ—¥å¿—
```

### æ—¥å¿—ç¤ºä¾‹

**DEBUGçº§åˆ«è¾“å‡º**ï¼š
```
========== è¯·æ±‚å¼€å§‹ ==========
è¯·æ±‚æ–¹æ³•: POST
è¯·æ±‚URI: /api/users
è¯·æ±‚URL: http://localhost:8090/api/users
å®¢æˆ·ç«¯IP: 127.0.0.1
è¯·æ±‚å¤´:
  Content-Type: application/json
  User-Agent: PostmanRuntime/7.29.0
è¯·æ±‚å‚æ•°:
  (æ— )
è¯·æ±‚ä½“: {"username":"testuser","email":"test@example.com"}
==============================

========== è¯·æ±‚ç»“æŸ ==========
è¯·æ±‚æ–¹æ³•: POST
è¯·æ±‚URI: /api/users
å“åº”çŠ¶æ€ç : 200
è€—æ—¶: 45ms
å“åº”å¤´:
  Content-Type: application/json
å“åº”ä½“: {"code":200,"status":true,"message":"æ“ä½œæˆåŠŸ",...}
==============================
```

**INFOçº§åˆ«è¾“å‡º**ï¼š
```
è¯·æ±‚å®Œæˆ - POST /api/users - çŠ¶æ€ç : 200 - è€—æ—¶: 45ms
```

### æ’é™¤è·¯å¾„

ä»¥ä¸‹è·¯å¾„ä¸ä¼šè¢«æ‹¦æˆªï¼š
- `/swagger-ui/**`
- `/v3/api-docs/**`
- `/swagger-ui.html`
- `/error`
- `/favicon.ico`

---

## ğŸ¯ å®Œæ•´ä½¿ç”¨ç¤ºä¾‹

### Controllerç¤ºä¾‹

```java
@RestController
@RequestMapping("/api/users")
@RequiredArgsConstructor
public class UserController {
    
    private final UserService userService;
    
    @GetMapping("/{id}")
    // è¿”å›å€¼ä¼šè‡ªåŠ¨åŒ…è£…ä¸ºResponseResult<User>
    public User getUser(@PathVariable Long id) {
        // å¦‚æœç”¨æˆ·ä¸å­˜åœ¨ï¼Œä¼šæŠ›å‡ºBusinessException
        // å…¨å±€å¼‚å¸¸å¤„ç†å™¨ä¼šè‡ªåŠ¨å¤„ç†å¹¶è¿”å›ç»Ÿä¸€é”™è¯¯æ ¼å¼
        return userService.getById(id);
    }
    
    @PostMapping
    // å‚æ•°æ ¡éªŒå¤±è´¥ä¼šè‡ªåŠ¨è¢«å…¨å±€å¼‚å¸¸å¤„ç†å™¨å¤„ç†
    public User createUser(@Validated @RequestBody UserCreateForm form) {
        // ä¸šåŠ¡é€»è¾‘å¼‚å¸¸ä¼šæŠ›å‡ºBusinessException
        return userService.create(form);
    }
}
```

### Serviceç¤ºä¾‹

```java
@Service
public class UserService extends ServiceImpl<UserMapper, User> implements IUserService {
    
    public User getById(Long id) {
        User user = this.getById(id);
        if (user == null) {
            // æŠ›å‡ºä¸šåŠ¡å¼‚å¸¸
            throw new BusinessException(ResultCode.DATA_NOT_EXIST, "ç”¨æˆ·ä¸å­˜åœ¨");
        }
        return user;
    }
    
    public User create(UserCreateForm form) {
        // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
        User existing = this.getOne(
            new LambdaQueryWrapper<User>()
                .eq(User::getUsername, form.getUsername())
        );
        if (existing != null) {
            throw new BusinessException("ç”¨æˆ·åå·²å­˜åœ¨");
        }
        
        // åˆ›å»ºç”¨æˆ·
        User user = BeanUtil.convert(form, User.class);
        this.save(user);
        return user;
    }
}
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å¼‚å¸¸å¤„ç†ä¼˜å…ˆçº§**ï¼šè‡ªå®šä¹‰å¼‚å¸¸ä¼šè¢«ä¼˜å…ˆå¤„ç†
2. **å“åº”åŒ…è£…**ï¼šå¦‚æœControllerå·²ç»è¿”å› `ResponseResult`ï¼Œä¸ä¼šé‡å¤åŒ…è£…
3. **æ—¥å¿—æ€§èƒ½**ï¼šç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨INFOçº§åˆ«ï¼Œé¿å…æ—¥å¿—è¿‡å¤š
4. **ç¯å¢ƒåˆ‡æ¢**ï¼šåˆ‡æ¢ç¯å¢ƒåéœ€è¦é‡å¯åº”ç”¨
5. **æ•æ„Ÿä¿¡æ¯**ï¼šæ—¥å¿—ä¸­å¯èƒ½åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼Œç”Ÿäº§ç¯å¢ƒæ³¨æ„è„±æ•

---

**æ‰€æœ‰åŠŸèƒ½å·²é›†æˆï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ï¼** ğŸ‰

